name: Build and Release Visual Studio Multi-project Template

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install template engine
        run: dotnet new -i Microsoft.TemplateEngine.Cli

      - name: Prepare template structure
        run: |
          set -e
          mkdir -p template/.template.config
          cp -r src OTManager.Data OTManager.Core OTManager.App README.md LICENSE.txt template/
          # Copia el archivo de soluciÃ³n si existe
          if [ -f OTManager.Wapi.sln ]; then cp OTManager.Wapi.sln template/; fi
          echo '{
  "author": "${{ github.repository_owner }}",
  "classifications": ["Web", "MultiProject"],
  "identity": "OTManager.Wapi.Template",
  "name": "OTManager Wapi MultiProject Template",
  "shortName": "otmanager-wapi",
  "tags": {
    "language": "C#",
    "type": "project"
  },
  "sourceName": "OTManager.Wapi"
}' > template/.template.config/template.json

      - name: Create template package (zip)
        run: |
          cd template
          zip -r ../OTManager.Wapi.Template.zip .
          cd ..

      - name: Validate template installation
        run: dotnet new --install ./OTManager.Wapi.Template.zip

      - name: Get release notes (all commits since last tag)
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo '')
          if [ -n "$PREV_TAG" ]; then
            git log $PREV_TAG..HEAD --pretty=format:"* %h %s" > changes.txt
          else
            git log --pretty=format:"* %h %s" > changes.txt
          fi
          echo 'RELEASE_NOTES<<EOF' >> $GITHUB_ENV
          cat changes.txt >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: 'OTManager.Wapi Template ${{ github.ref_name }}'
          body: ${{ env.RELEASE_NOTES }}
          files: OTManager.Wapi.Template.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up
        run: rm -rf template OTManager.Wapi.Template.zip changes.txt
